{"version":3,"sources":["src/dev/devServer.ts"],"sourcesContent":["import { moduleLoader } from \"@queue-run/builder\";\nimport { handler } from \"@queue-run/runtime\";\nimport crypto from \"crypto\";\nimport { createServer } from \"http\";\nimport { URL } from \"url\";\n\nexport default async function devServer({ port }: { port: number }) {\n  const server = createServer(async function (req, res) {\n    const method = req.method?.toLocaleUpperCase() ?? \"GET\";\n    const headers = Object.fromEntries(\n      Object.entries(req.headers).map(([name, value]) => [name, String(value)])\n    );\n    const url = new URL(req.url ?? \"/\", `http://${headers.host}`);\n    let data: Buffer[] = [];\n    for await (const chunk of req) data.push(chunk);\n    const body = Buffer.concat(data).toString(\"base64\");\n\n    const lambdaEvent = {\n      method,\n      url: url.href,\n      headers,\n      body,\n    };\n    const functionName = headers.host!.split(\":\")[0];\n    const timeout = Date.now() + 10 * 1000;\n    const lambdaContext = {\n      awsRequestId: crypto.randomBytes(8).toString(\"hex\"),\n      callbackWaitsForEmptyEventLoop: false,\n      functionName,\n      functionVersion: \"0\",\n      getRemainingTimeInMillis: () => timeout - Date.now(),\n      invokedFunctionArn: `arn:aws:lambda:localhost:12345:function:${functionName}:${functionName}-dev`,\n      logGroupName: functionName,\n      memoryLimitInMB: \"1024\",\n    };\n\n    const response = await handler(lambdaEvent, lambdaContext);\n    if (response) {\n      console.info(\"%s %s => %s\", method, req.url, response.statusCode);\n      res.writeHead(response.statusCode, response.headers);\n      res.end(Buffer.from(response.body, \"base64\"));\n    } else {\n      console.info(\"%s => 500\", req.url);\n      res.writeHead(500).end(\"Internal Server Error\");\n    }\n  });\n  await moduleLoader({ dirname: process.cwd(), watch: true });\n  server.listen(port, () => {\n    console.info(\"ðŸ‘‹ Dev server listening on http://localhost:%d\", port);\n  });\n  await new Promise((resolve, reject) =>\n    server.on(\"close\", resolve).on(\"error\", reject)\n  );\n}\n"],"names":["devServer","port","server","req","res","method","toLocaleUpperCase","headers","Object","fromEntries","entries","map","name","value","String","url","host","data","chunk","push","body","Buffer","concat","toString","lambdaEvent","href","functionName","split","timeout","Date","now","lambdaContext","awsRequestId","randomBytes","callbackWaitsForEmptyEventLoop","functionVersion","getRemainingTimeInMillis","invokedFunctionArn","logGroupName","memoryLimitInMB","response","console","info","statusCode","writeHead","end","from","dirname","process","cwd","watch","listen","Promise","resolve","reject","on"],"mappings":"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"}