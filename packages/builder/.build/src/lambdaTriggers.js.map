{"version":3,"sources":["src/lambdaTriggers.ts"],"sourcesContent":["import { Lambda } from \"@aws-sdk/client-lambda\";\n\nexport async function addTriggers({\n  lambdaName,\n  region,\n  sourceArns,\n}: {\n  lambdaName: string;\n  region: string;\n  sourceArns: string[];\n}) {\n  const lambda = new Lambda({ region });\n\n  if (sourceArns.length === 0) return;\n  const { EventSourceMappings } = await lambda.listEventSourceMappings({\n    FunctionName: lambdaName,\n  });\n  const arnToUUID = new Map<string, string>(\n    EventSourceMappings?.map(\n      ({ EventSourceArn, UUID }) => [EventSourceArn, UUID] as [string, string]\n    )\n  );\n\n  const created = await Promise.all(\n    sourceArns.map(async (arn) => {\n      const uuid = arnToUUID.get(arn);\n      if (uuid) {\n        await lambda.updateEventSourceMapping({\n          UUID: uuid,\n          FunctionName: lambdaName,\n        });\n        return false;\n      } else {\n        const { UUID } = await lambda.createEventSourceMapping({\n          Enabled: true,\n          FunctionName: lambdaName,\n          EventSourceArn: arn,\n        });\n        if (!UUID) throw new Error(`Could not create event source for ${arn}`);\n        return true;\n      }\n    })\n  );\n  if (created.some(Boolean)) console.info(\"λ: Added new triggers\");\n}\n\nexport async function removeTriggers({\n  lambdaName,\n  region,\n  sourceArns,\n}: {\n  lambdaName: string;\n  region: string;\n  sourceArns: string[];\n}) {\n  const lambda = new Lambda({ region });\n\n  const { EventSourceMappings } = await lambda.listEventSourceMappings({\n    FunctionName: lambdaName,\n  });\n  if (!EventSourceMappings) return;\n\n  const set = new Set(sourceArns);\n  const removing = EventSourceMappings.filter(\n    ({ EventSourceArn }) => EventSourceArn && !set.has(EventSourceArn)\n  );\n  if (removing.length === 0) return;\n\n  await Promise.all(\n    removing.map(({ UUID }) => lambda.deleteEventSourceMapping({ UUID }))\n  );\n  console.info(\"λ: Removed old triggers\");\n}\n"],"names":["addTriggers","removeTriggers","lambdaName","region","sourceArns","lambda","length","EventSourceMappings","listEventSourceMappings","FunctionName","arnToUUID","Map","map","EventSourceArn","UUID","created","Promise","all","arn","uuid","get","updateEventSourceMapping","createEventSourceMapping","Enabled","Error","some","Boolean","console","info","set","Set","removing","filter","has","deleteEventSourceMapping"],"mappings":"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"}