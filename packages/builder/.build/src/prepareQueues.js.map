{"version":3,"sources":["src/prepareQueues.ts"],"sourcesContent":["import { QueueConfig } from \"@assaf/untitled-runtime\";\nimport { SQS } from \"@aws-sdk/client-sqs\";\nimport { queueURLToARN, queueURLToName } from \"./util\";\n\nexport async function createQueues({\n  configs,\n  prefix,\n  region,\n}: {\n  configs: Map<string, { config?: QueueConfig }>;\n  prefix: string;\n  region: string;\n}): Promise<string[]> {\n  const sqs = new SQS({ region });\n\n  return await Promise.all(\n    Array.from(configs.entries()).map(async ([name, { config }]) => {\n      const fifo = config?.fifo ? \".fifo\" : \"\";\n      const { QueueUrl } = await sqs.createQueue({\n        QueueName: `${prefix}${name}${fifo}`,\n      });\n      if (!QueueUrl) throw new Error(`Could not create queue ${name}`);\n      const arn = queueURLToARN(QueueUrl);\n      console.info(\"µ: Created queue %s\", name);\n      return arn;\n    })\n  );\n}\n\nexport async function deleteOldQueues({\n  prefix,\n  queueArns,\n  region,\n}: {\n  prefix: string;\n  queueArns: string[];\n  region: string;\n}) {\n  const sqs = new SQS({ region });\n\n  const { QueueUrls } = await sqs.listQueues({\n    QueueNamePrefix: prefix,\n  });\n  if (!QueueUrls) return;\n\n  const set = new Set(queueArns);\n  const toDelete = QueueUrls.filter(\n    (QueueUrl) => !set.has(queueURLToARN(QueueUrl))\n  );\n  if (toDelete.length === 0) return;\n\n  console.info(\n    \"µ: Deleting old queues %s …\",\n    toDelete.map(queueURLToName).join(\", \")\n  );\n  await Promise.all(\n    toDelete.map(async (QueueUrl) => sqs.deleteQueue({ QueueUrl }))\n  );\n}\n"],"names":["createQueues","deleteOldQueues","configs","prefix","region","sqs","Promise","all","Array","from","entries","map","name","config","fifo","QueueUrl","createQueue","QueueName","Error","arn","console","info","queueArns","QueueUrls","listQueues","QueueNamePrefix","set","Set","toDelete","filter","has","length","join","deleteQueue"],"mappings":";;;;QAIsBA,YAAY,GAAZA,YAAY;QAyBZC,eAAe,GAAfA,eAAe;AA5BjB,GAAqB,CAArB,UAAqB;AACK,GAAQ,CAAR,KAAQ;eAEhCD,YAAY,CAAC,CAAC,CAClCE,OAAO,GACPC,MAAM,GACNC,MAAM,EAKR,CAAC,EAAqB,CAAC;IACrB,KAAK,CAACC,GAAG,GAAG,GAAG,CAZG,UAAqB,KAYnB,CAAC;QAACD,MAAM;IAAC,CAAC;IAE9B,MAAM,CAAC,KAAK,CAACE,OAAO,CAACC,GAAG,CACtBC,KAAK,CAACC,IAAI,CAACP,OAAO,CAACQ,OAAO,IAAIC,GAAG,SAASC,IAAI,EAAE,CAAC,CAACC,MAAM,EAAC,CAAC,IAAM,CAAC;QAC/D,KAAK,CAACC,IAAI,IAAGD,MAAM,aAANA,MAAM,KAANA,IAAI,CAAJA,CAAY,GAAZA,IAAI,CAAJA,CAAY,GAAZA,MAAM,CAAEC,IAAI,IAAG,CAAO,SAAG,CAAE;QACxC,KAAK,CAAC,CAAC,CAACC,QAAQ,EAAC,CAAC,GAAG,KAAK,CAACV,GAAG,CAACW,WAAW,CAAC,CAAC;YAC1CC,SAAS,KAAKd,MAAM,GAAGS,IAAI,GAAGE,IAAI;QACpC,CAAC;QACD,EAAE,GAAGC,QAAQ,EAAE,KAAK,CAAC,GAAG,CAACG,KAAK,EAAE,uBAAuB,EAAEN,IAAI;QAC7D,KAAK,CAACO,GAAG,OApB+B,KAAQ,gBAoBtBJ,QAAQ;QAClCK,OAAO,CAACC,IAAI,CAAC,CAAsB,yBAAET,IAAI;QACzC,MAAM,CAACO,GAAG;IACZ,CAAC;AAEL,CAAC;eAEqBlB,eAAe,CAAC,CAAC,CACrCE,MAAM,GACNmB,SAAS,GACTlB,MAAM,EAKR,CAAC,EAAE,CAAC;IACF,KAAK,CAACC,GAAG,GAAG,GAAG,CArCG,UAAqB,KAqCnB,CAAC;QAACD,MAAM;IAAC,CAAC;IAE9B,KAAK,CAAC,CAAC,CAACmB,SAAS,EAAC,CAAC,GAAG,KAAK,CAAClB,GAAG,CAACmB,UAAU,CAAC,CAAC;QAC1CC,eAAe,EAAEtB,MAAM;IACzB,CAAC;IACD,EAAE,GAAGoB,SAAS,EAAE,MAAM;IAEtB,KAAK,CAACG,GAAG,GAAG,GAAG,CAACC,GAAG,CAACL,SAAS;IAC7B,KAAK,CAACM,QAAQ,GAAGL,SAAS,CAACM,MAAM,EAC9Bd,QAAQ,IAAMW,GAAG,CAACI,GAAG,KA7CoB,KAAQ,gBA6Cbf,QAAQ;;IAE/C,EAAE,EAAEa,QAAQ,CAACG,MAAM,KAAK,CAAC,EAAE,MAAM;IAEjCX,OAAO,CAACC,IAAI,CACV,CAA6B,mCAC7BO,QAAQ,CAACjB,GAAG,CAnD8B,KAAQ,iBAmDrBqB,IAAI,CAAC,CAAI;IAExC,KAAK,CAAC1B,OAAO,CAACC,GAAG,CACfqB,QAAQ,CAACjB,GAAG,QAAQI,QAAQ,GAAKV,GAAG,CAAC4B,WAAW,CAAC,CAAC;YAAClB,QAAQ;QAAC,CAAC;;AAEjE,CAAC"}