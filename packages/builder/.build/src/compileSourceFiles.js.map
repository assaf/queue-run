{"version":3,"sources":["src/compileSourceFiles.ts"],"sourcesContent":["import * as swc from \"@swc/core\";\nimport glob from \"fast-glob\";\nimport { copyFile, mkdir, readFile, writeFile } from \"fs/promises\";\nimport path from \"path\";\n\nexport default async function compileSourceFiles({\n  envVars,\n  sourceDir,\n  targetDir,\n}: {\n  envVars: Record<string, string>;\n  sourceDir: string;\n  targetDir: string;\n}) {\n  console.info(\"Î»: Building %s\", targetDir);\n\n  const ignore = (\n    await readFile(path.join(sourceDir, \".gitignore\"), \"utf-8\").catch(() => \"\")\n  )\n    .split(\"\\n\")\n    .filter((line) => line.trim().length > 0 && !line.startsWith(\"#\"));\n\n  const filenames = glob.sync(\"**/*\", {\n    cwd: sourceDir,\n    followSymbolicLinks: true,\n    ignore: [...ignore, \"**/node_modules/**\"],\n    markDirectories: true,\n    unique: true,\n  });\n  for (const filename of filenames) {\n    const dest = path.join(targetDir, path.relative(sourceDir, filename));\n    if (filename.endsWith(\"/\")) {\n      await mkdir(dest, { recursive: true });\n    } else {\n      await mkdir(path.dirname(dest), { recursive: true });\n      if (filename.endsWith(\".ts\"))\n        await compileTypeScript({ filename, dest, envVars });\n      else await copyFile(filename, dest);\n    }\n  }\n}\n\nasync function compileTypeScript({\n  dest,\n  envVars,\n  filename,\n}: {\n  dest: string;\n  envVars: Record<string, string>;\n  filename: string;\n}) {\n  const { code, map } = await swc.transformFile(filename, {\n    envName: process.env.NODE_ENV,\n    env: { targets: { node: 14 } },\n    jsc: {\n      parser: { syntax: \"typescript\" },\n      transform: { optimizer: { globals: { vars: envVars } } },\n    },\n    sourceMaps: true,\n    module: { type: \"commonjs\", noInterop: true },\n  });\n  await writeFile(dest.replace(/\\.ts$/, \".js\"), code, \"utf-8\");\n  if (map) await writeFile(dest.replace(/\\.ts$/, \".js.map\"), map, \"utf-8\");\n}\n"],"names":["compileSourceFiles","swc","envVars","sourceDir","targetDir","console","info","ignore","join","catch","split","filter","line","trim","length","startsWith","filenames","sync","cwd","followSymbolicLinks","markDirectories","unique","filename","dest","relative","endsWith","recursive","dirname","compileTypeScript","code","map","transformFile","envName","process","env","NODE_ENV","targets","node","jsc","parser","syntax","transform","optimizer","globals","vars","sourceMaps","module","type","noInterop","replace"],"mappings":"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"}