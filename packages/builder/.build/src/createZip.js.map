{"version":3,"sources":["src/createZip.ts"],"sourcesContent":["import glob from \"fast-glob\";\nimport filesize from \"filesize\";\nimport { lstat, readFile } from \"fs/promises\";\nimport JSZip from \"jszip\";\nimport ms from \"ms\";\nimport path from \"path\";\n\nexport default async function createZip(dirname: string): Promise<Uint8Array> {\n  const start = Date.now();\n  console.info(\"λ: Zipping %s\", dirname);\n\n  const zip = new JSZip();\n  const filenames = glob.sync(\"**/*\", {\n    cwd: dirname,\n    dot: true,\n    followSymbolicLinks: true,\n    onlyFiles: true,\n  });\n  await Promise.all(\n    filenames.map(async (filename) => {\n      const filepath = path.resolve(dirname, filename);\n      const stat = await lstat(filepath);\n      if (!(stat.isDirectory() || stat.isSymbolicLink()))\n        zip.file(filename, await readFile(filepath));\n    })\n  );\n\n  const buffer = await zip.generateAsync({\n    type: \"uint8array\",\n    compression: \"DEFLATE\",\n    compressionOptions: { level: 9 },\n  });\n  console.info(\"λ: Zipped %s\", filesize(buffer.byteLength));\n\n  const folders = new Map<string, number>();\n  await Promise.all(\n    Object.values(zip.files).map(async (entry) => {\n      const dirname = path.dirname(entry.name);\n      const folder = summaryFolderName(dirname);\n      const { byteLength } = await entry.async(\"uint8array\");\n      folders.set(folder, (folders.get(folder) ?? 0) + byteLength);\n    })\n  );\n  for (const [dirname, size] of folders) {\n    if (size > 0)\n      console.info(\"   %s   %s\", truncated(dirname), filesize(size));\n  }\n\n  console.info(\"✨  Done in %s.\", ms(Date.now() - start));\n  return buffer;\n}\n\nfunction summaryFolderName(dirname: string): string {\n  if (dirname === \".\") return \"/\";\n  if (dirname.startsWith(\"node_modules/\")) {\n    const parts = dirname.split(\"/\");\n    return parts.slice(0, parts[1]?.startsWith(\"@\") ? 3 : 2).join(\"/\");\n  } else return dirname;\n}\n\nfunction truncated(dirname: string) {\n  if (dirname.length < 40) return dirname.padEnd(40);\n  if (dirname.length > 40)\n    return dirname.replace(/^(.{19}).*(.{20})$/, \"$1…$2\");\n  return dirname;\n}\n"],"names":["createZip","dirname","start","Date","now","console","info","zip","filenames","sync","cwd","dot","followSymbolicLinks","onlyFiles","Promise","all","map","filename","filepath","resolve","stat","isDirectory","isSymbolicLink","file","buffer","generateAsync","type","compression","compressionOptions","level","byteLength","folders","Map","Object","values","files","entry","name","folder","summaryFolderName","async","set","get","size","truncated","startsWith","parts","split","slice","join","length","padEnd","replace"],"mappings":"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"}