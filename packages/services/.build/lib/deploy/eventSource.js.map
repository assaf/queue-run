{"version":3,"sources":["/Users/assaf/Projects/queue.run/packages/services/lib/deploy/eventSource.ts"],"sourcesContent":["import { Lambda } from \"@aws-sdk/client-lambda\";\n\nexport async function addTriggers({\n  lambdaARN,\n  sourceARNs,\n}: {\n  lambdaARN: string;\n  sourceARNs: string[];\n}) {\n  const lambda = new Lambda({});\n\n  if (sourceARNs.length === 0) return;\n  const { EventSourceMappings } = await lambda.listEventSourceMappings({\n    FunctionName: lambdaARN,\n  });\n  const arnToUUID = new Map<string, string>(\n    EventSourceMappings?.map(\n      ({ EventSourceArn, UUID }) => [EventSourceArn, UUID] as [string, string]\n    )\n  );\n\n  const created = await Promise.all(\n    sourceARNs.map(async (arn) => {\n      const uuid = arnToUUID.get(arn);\n      if (uuid) {\n        await lambda.updateEventSourceMapping({\n          UUID: uuid,\n          FunctionName: lambdaARN,\n        });\n        return false;\n      } else {\n        const { UUID } = await lambda.createEventSourceMapping({\n          Enabled: true,\n          EventSourceArn: arn,\n          FunctionName: lambdaARN,\n          FunctionResponseTypes: [\"ReportBatchItemFailures\"],\n        });\n        if (!UUID) throw new Error(`Could not create event source for ${arn}`);\n        return true;\n      }\n    })\n  );\n  if (created.some(Boolean)) console.info(\"λ: Added new triggers\");\n}\n\nexport async function removeTriggers({\n  lambdaARN,\n  sourceARNs,\n}: {\n  lambdaARN: string;\n  sourceARNs: string[];\n}) {\n  const lambda = new Lambda({});\n\n  const { EventSourceMappings } = await lambda.listEventSourceMappings({\n    FunctionName: lambdaARN,\n  });\n  if (!EventSourceMappings) return;\n\n  const set = new Set(sourceARNs);\n  const removing = EventSourceMappings.filter(\n    ({ EventSourceArn }) => EventSourceArn && !set.has(EventSourceArn)\n  );\n  if (removing.length === 0) return;\n\n  await Promise.all(\n    removing.map(({ UUID }) => lambda.deleteEventSourceMapping({ UUID }))\n  );\n  console.info(\"λ: Removed old triggers\");\n}\n"],"names":["addTriggers","removeTriggers","lambdaARN","sourceARNs","lambda","length","EventSourceMappings","listEventSourceMappings","FunctionName","arnToUUID","Map","map","EventSourceArn","UUID","created","Promise","all","arn","uuid","get","updateEventSourceMapping","createEventSourceMapping","Enabled","FunctionResponseTypes","Error","some","Boolean","console","info","set","Set","removing","filter","has","deleteEventSourceMapping"],"mappings":"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"}